---
title: "Survival Analysis Final Project – Exploratory Data Analysis"
author: "Jing Lyu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)


library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(tableone)
library(scales)
library(gtsummary)

```

# Introduction

This report presents the exploratory data analysis (EDA) for the survival analysis project on heart failure patients.  

The aim of this EDA is to:

- Describe the distribution of demographic and clinical variables;
- Compare characteristics between patients who died and those who survived (censored);
- Explore univariate survival patterns using Kaplan–Meier (KM) curves and log-rank tests for key predictors.

The results from this EDA will inform later multivariable modelling (e.g., Cox proportional hazards model and Random Survival Forest).

# Data and Variables

## Data source

The dataset contains 299 heart failure patients and was collected in Pakistan over a follow-up period of up to 9 months.  
Each row corresponds to one patient.

```{r load-data}
# NOTE: Change the file name / path if needed
# Common Kaggle filename: "heart_failure_clinical_records_dataset.csv"

heart <- read.csv("heart_failure_clinical_records_dataset.csv")

# Quick check of structure
str(heart)
summary(heart)
```

## Variable description

The key variables used in this EDA are:

- **time**: follow-up time (days)  
- **DEATH_EVENT**: death indicator (1 = died during follow-up, 0 = censored / alive)  

Clinical and demographic predictors:

- **age**: age (years)  
- **anaemia**: anaemia (1 = yes, 0 = no)  
- **creatinine_phosphokinase**: CPK enzyme level (mcg/L)  
- **diabetes**: diabetes (1 = yes, 0 = no)  
- **ejection_fraction**: percentage of blood leaving the heart at each contraction (%)  
- **high_blood_pressure**: high blood pressure (1 = yes, 0 = no)  
- **platelets**: platelets (kiloplatelets/mL)  
- **serum_creatinine**: serum creatinine (mg/dL)  
- **serum_sodium**: serum sodium (mEq/L)  
- **sex**: sex (1 = male, 0 = female)  
- **smoking**: smoking (1 = yes, 0 = no)  

For convenience in plots and tables, we convert several binary variables to factors with labels.

```{r recode-factors}
heart <- heart %>%
  mutate(
    DEATH_EVENT   = factor(DEATH_EVENT, levels = c(0, 1), labels = c("Alive/Censored", "Died")),
    anaemia       = factor(anaemia, levels = c(0, 1), labels = c("No", "Yes")),
    diabetes      = factor(diabetes, levels = c(0, 1), labels = c("No", "Yes")),
    high_blood_pressure = factor(high_blood_pressure, levels = c(0, 1), labels = c("No", "Yes")),
    sex           = factor(sex, levels = c(0, 1), labels = c("Female", "Male")),
    smoking       = factor(smoking, levels = c(0, 1), labels = c("No", "Yes"))
  )

str(heart)
```

# Descriptive Statistics

## Overall summary

We first summarize all variables in the full cohort.

```{r overall-summary}
# Define continuous and categorical variables
cont_vars <- c("age", "creatinine_phosphokinase", "ejection_fraction",
               "platelets", "serum_creatinine", "serum_sodium", "time")

cat_vars  <- c("sex", "anaemia", "diabetes",
               "high_blood_pressure", "smoking", "DEATH_EVENT")

# Optional: nicer labels for variables
var_labels <- list(
  age                      = "Age (years)",
  creatinine_phosphokinase = "Creatinine phosphokinase (mcg/L)",
  ejection_fraction        = "Ejection fraction (%)",
  platelets                = "Platelets (kiloplatelets/mL)",
  serum_creatinine         = "Serum creatinine (mg/dL)",
  serum_sodium             = "Serum sodium (mEq/L)",
  time                     = "Follow-up time (days)",
  sex                      = "Sex",
  anaemia                  = "Anaemia",
  diabetes                 = "Diabetes",
  high_blood_pressure      = "High blood pressure",
  smoking                  = "Smoking",
  DEATH_EVENT              = "Death during follow-up"
)

table1_gtsum <-
  heart |>
  dplyr::select(all_of(c(cont_vars, cat_vars))) |>
  tbl_summary(
    # 不分组 → 总体描述
    by = NULL,
    label = var_labels,
    # 连续变量统计方式
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(
      all_continuous2() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")
    ),
    missing = "ifany"
  ) |>
  modify_header(label ~ "**Variable**") |>
  bold_labels()

table1_gtsum
```

*Interpretation notes:*

Regarding demographics and comorbidities, 65% were male, 43% had anaemia, 42% had diabetes, 35% had hypertension, and 32% were smokers. During follow-up, 32% of patients died, while 68% remained alive or were censored, reflecting substantial event occurrence suitable for survival modelling.

## Characteristics by survival status

Next, we compare patient characteristics by survival status (`DEATH_EVENT`).

```{r by-status-summary}
table_by_status_gtsum <-
  heart |>
  # 把 DEATH_EVENT 放在最前面做分层
  dplyr::select(DEATH_EVENT, all_of(cont_vars), all_of(setdiff(cat_vars, "DEATH_EVENT"))) |>
  tbl_summary(
    by = DEATH_EVENT,
    label = var_labels,
    type = list(
      all_continuous() ~ "continuous2"
    ),
    statistic = list(
      all_continuous2() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})")
    ),
    missing = "ifany"
  ) |>
  add_p(test = list(
    all_continuous() ~ "wilcox.test",
    all_categorical() ~ "chisq.test"
  )) |>
  modify_header(
    label ~ "**Variable**",
    stat_1 ~ "**Alive/Censored**",
    stat_2 ~ "**Died**",
    p.value ~ "**p-value**"
  ) |>
  bold_labels()

table_by_status_gtsum
```



*Interpretation notes :*

Patients who died were significantly older, had worse cardiac function(low Ejection Fraction), and showed evidence of renal dysfunction(higher Serum Creatinine) and electrolyte imbalance(lower Serum Sodium), aligning with known heart failure risk pathways. Conversely, CPK, platelet count, and comorbidity indicators (anaemia, diabetes, hypertension, smoking) did not differ significantly, suggesting weaker prognostic influence in this cohort.

Overall, the descriptive findings indicate that *age, ejection fraction, serum creatinine, and serum sodium* are strong mortality-associated biomarkers, while lifestyle and comorbidity profiles appear less discriminatory. **These variables are strong candidates to carry forward into univariate KM and multivariable survival modelling.**

# Distribution of Key Variables

In this section we explore the distributions of continuous and categorical variables, overall and by survival status.

## Continuous variables

We use histograms and boxplots stratified by survival status.

```{r dist-continuous, fig.height=7, fig.width=7}
# Histogram example: age
ggplot(heart, aes(x = age)) +
  geom_histogram(bins = 20) +
  labs(title = "Distribution of Age", x = "Age (years)", y = "Count")

# Boxplot by survival status: age
ggplot(heart, aes(x = DEATH_EVENT, y = age, fill = DEATH_EVENT)) +
  geom_boxplot() +
  labs(title = "Age by Survival Status", x = "Survival status", y = "Age (years)") +
  theme(legend.position = "none")
```


```{r dist-other-continuous, fig.height=7, fig.width=7}
# Creatinine phosphokinase (mcg/L)
ggplot(heart, aes(x = DEATH_EVENT, y = creatinine_phosphokinase, fill = DEATH_EVENT)) +
  geom_boxplot() +
  labs(title = "Creatinine phosphokinase by Survival Status", x = "Survival status", y = "Creatinine phosphokinase (mcg/L)") +
  theme(legend.position = "none")


# Ejection fraction
ggplot(heart, aes(x = DEATH_EVENT, y = ejection_fraction, fill = DEATH_EVENT)) +
  geom_boxplot() +
  labs(title = "Ejection Fraction by Survival Status", x = "Survival status", y = "Ejection fraction (%)") +
  theme(legend.position = "none")

# Serum creatinine
ggplot(heart, aes(x = DEATH_EVENT, y = serum_creatinine, fill = DEATH_EVENT)) +
  geom_boxplot() +
  labs(title = "Serum Creatinine by Survival Status", x = "Survival status", y = "Serum creatinine (mg/dL)") +
  theme(legend.position = "none")

# Serum sodium
ggplot(heart, aes(x = DEATH_EVENT, y = serum_sodium, fill = DEATH_EVENT)) +
  geom_boxplot() +
  labs(title = "Serum Sodium by Survival Status", x = "Survival status", y = "Serum sodium (mEq/L)") +
  theme(legend.position = "none")
```

An aggregated version: 

```{r dist-continuous-aggregate, fig.height=7, fig.width=9}
library(tidyr)

# Continuous variables
num_vars <- c("age",
              "creatinine_phosphokinase",
              "ejection_fraction",
              "platelets",
              "serum_creatinine",
              "serum_sodium",
              "time")

# Pretty labels for facets
var_labels <- c(
  age                      = "Age (years)",
  creatinine_phosphokinase = "Creatinine phosphokinase (mcg/L)",
  ejection_fraction        = "Ejection fraction (%)",
  platelets                = "Platelets (k/mL)",
  serum_creatinine         = "Serum creatinine (mg/dL)",
  serum_sodium             = "Serum sodium (mEq/L)",
  time                     = "Follow-up time (days)"
)

heart_cont_long <- heart %>%
  dplyr::select(DEATH_EVENT, all_of(num_vars)) %>%
  pivot_longer(
    cols = all_of(num_vars),
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    Variable = factor(Variable,
                      levels = num_vars,
                      labels = var_labels[num_vars])
  )

ggplot(heart_cont_long,
       aes(x = DEATH_EVENT, y = Value, fill = DEATH_EVENT)) +
  geom_boxplot(outlier.alpha = 0.4) +
  facet_wrap(~ Variable, scales = "free_y") +
  labs(
    title = "Continuous Predictors by Survival Status",
    x = "Survival status",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

## Categorical variables

An aggregated version: 

```{r dist-categorical-aggregate, fig.height=6, fig.width=9}
library(tidyr)

cat_vars_plot <- c("sex", "anaemia", "diabetes", "high_blood_pressure", "smoking")

heart_cat_long <- heart %>%
  select(DEATH_EVENT, all_of(cat_vars_plot)) %>%
  pivot_longer(
    cols = all_of(cat_vars_plot),
    names_to = "Variable",
    values_to = "Level"
  )

ggplot(heart_cat_long, aes(x = Level, fill = DEATH_EVENT)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Proportion of Death Events by Categorical Predictors",
    x = NULL,
    y = "Percentage",
    fill = "Survival status"
  ) +
  facet_wrap(~ Variable, nrow = 2, scales = "free_x") +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

# Univariate Survival Exploration: Kaplan–Meier Curves

In this section, we examine how survival time differs across subgroups of individual variables using univariate Kaplan–Meier (KM) curves and log-rank tests.

We first create a `Surv` object using time to event and death indicator.

```{r surv-object}
surv_obj <- Surv(time = heart$time, event = heart$DEATH_EVENT == "Died")
surv_obj
```

## KM curves for binary clinical variables

### Sex

```{r km-sex, fig.height=6, fig.width=7}
fit_sex <- survfit(surv_obj ~ sex, data = heart)

ggsurvplot(
  fit_sex,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Sex"
)

# Log-rank test
survdiff(surv_obj ~ sex, data = heart)
```

### Anaemia

```{r km-anaemia, fig.height=6, fig.width=7}
fit_anaemia <- survfit(surv_obj ~ anaemia, data = heart)

ggsurvplot(
  fit_anaemia,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Anaemia"
)

survdiff(surv_obj ~ anaemia, data = heart)
```

### Diabetes

```{r km-diabetes, fig.height=6, fig.width=7}
fit_diabetes <- survfit(surv_obj ~ diabetes, data = heart)

ggsurvplot(
  fit_diabetes,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Diabetes"
)

survdiff(surv_obj ~ diabetes, data = heart)
```

### High blood pressure

```{r km-hbp, fig.height=6, fig.width=7}
fit_hbp <- survfit(surv_obj ~ high_blood_pressure, data = heart)

ggsurvplot(
  fit_hbp,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "High blood pressure"
)

survdiff(surv_obj ~ high_blood_pressure, data = heart)
```

### Smoking

```{r km-smoking, fig.height=6, fig.width=7}
fit_smoking <- survfit(surv_obj ~ smoking, data = heart)

ggsurvplot(
  fit_smoking,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Smoking"
)

survdiff(surv_obj ~ smoking, data = heart)
```

## KM curves for grouped continuous variables

For continuous predictors, we create grouped versions and then draw KM curves.

```{r create-groups}
heart <- heart %>%
  mutate(
    # Age quartiles
    age_group = cut(
      age,
      breaks = quantile(age, probs = seq(0, 1, by = 0.25), na.rm = TRUE),
      include.lowest = TRUE,
      dig.lab = 4
    ),
    # Ejection fraction: clinically meaningful cutoffs (example)
    ef_group = cut(
      ejection_fraction,
      breaks = c(-Inf, 30, 45, Inf),
      labels = c("<=30", "30–45", ">45")
    ),
    # Serum creatinine quartiles
    creatinine_group = cut(
      serum_creatinine,
      breaks = quantile(serum_creatinine, probs = seq(0, 1, by = 0.25), na.rm = TRUE),
      include.lowest = TRUE,
      dig.lab = 4
    ),
    # Serum sodium quartiles
    sodium_group = cut(
      serum_sodium,
      breaks = quantile(serum_sodium, probs = seq(0, 1, by = 0.25), na.rm = TRUE),
      include.lowest = TRUE,
      dig.lab = 4
    )
  )

summary(heart$age_group)
summary(heart$ef_group)
summary(heart$creatinine_group)
summary(heart$sodium_group)

# Update Surv object after creating groups (same definition)
surv_obj <- Surv(time = heart$time, event = heart$DEATH_EVENT == "Died")
```

### Age groups

```{r km-age, fig.height=6, fig.width=9}
fit_age <- survfit(surv_obj ~ age_group, data = heart)

ggsurvplot(
  fit_age,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Age group"
)

survdiff(surv_obj ~ age_group, data = heart)
```

### Ejection fraction groups

```{r km-ef, fig.height=7, fig.width=7}
fit_ef <- survfit(surv_obj ~ ef_group, data = heart)

ggsurvplot(
  fit_ef,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Ejection fraction group"
)

survdiff(surv_obj ~ ef_group, data = heart)
```

### Serum creatinine groups

```{r km-creatinine, fig.height=10, fig.width=10}
fit_creat <- survfit(surv_obj ~ creatinine_group, data = heart)

ggsurvplot(
  fit_creat,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Serum creatinine (quartiles)"
)

survdiff(surv_obj ~ creatinine_group, data = heart)
```

### Serum sodium groups

```{r km-sodium, fig.height=7, fig.width=8}
fit_sodium <- survfit(surv_obj ~ sodium_group, data = heart)

ggsurvplot(
  fit_sodium,
  data = heart,
  risk.table = TRUE,
  pval = TRUE,
  conf.int = FALSE,
  legend.title = "Serum sodium (quartiles)"
)

survdiff(surv_obj ~ sodium_group, data = heart)
```


# Summary of EDA Findings


- Which variables show clear differences between patients who died and those who survived in the descriptive tables?

Patients who died tended to be older, had **lower ejection fraction, higher serum creatinine, and lower sodium levels**, indicating more severe cardiac and renal dysfunction. Sex, diabetes, smoking, and anaemia showed minimal differences between groups.

- Which KM curves show clear separation and statistically significant log-rank tests?

Clear separation was observed for high blood pressure, age >70, ejection fraction <30%, serum creatinine >1.4 mg/dL or serum creatinine < 0.9 mg/dL , and serum sodium 113–134 mEq/L, all demonstrating visibly worse survival patterns.(Anaemia's P value is 0.099, not significant, but there's serparated patten between 2 lines)

- Are the directions consistent with clinical expectations

Yes — poorer survival was associated with low EF, high creatinine, and low sodium, which aligns with known pathways of heart failure severity and cardiorenal decline. Older age also behaved predictably as a strong mortality predictor.

- Which variables appear promising to include in later multivariable models?

The strongest candidates include **age, ejection fraction, serum creatinine, serum sodium, and high blood pressure**, as they demonstrated both statistical relevance and clear biological interpretability.
